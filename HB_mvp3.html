<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Health Buddy | Multilingual Health AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { width: 100%; height: 100%; overflow: hidden; }
        body { font-family: 'Inter', sans-serif; background: #f3f4f6; display: flex; align-items: center; justify-content: center; }
        
        .chat-bubble-user { background-color: #DCF8C6; align-self: flex-end; border-bottom-right-radius: 12px; border-bottom-left-radius: 12px; border-top-left-radius: 12px; }
        .chat-bubble-bot { background-color: #FFFFFF; align-self: flex-start; border-bottom-right-radius: 12px; border-bottom-left-radius: 12px; border-top-right-radius: 12px; }
        
        .typing-indicator { display: flex; gap: 4px; padding: 10px; }
        .typing-dot { width: 8px; height: 8px; border-radius: 50%; background-color: #999; animation: typing 1.4s infinite; }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing { 0%, 60%, 100% { opacity: 0.3; transform: translateY(0); } 30% { opacity: 1; transform: translateY(-10px); } }

        .menu-button {
            background-color: #ffffff; border: 1.5px solid #0d9488; color: #0d9488;
            padding: 0.6rem 1.2rem; margin: 0.3rem; border-radius: 9999px;
            cursor: pointer; font-size: 0.85rem; font-weight: 500; transition: all 0.2s ease;
        }
        .menu-button:hover { background-color: #0d9488; color: #ffffff; transform: translateY(-1.5px); }

        .sos-btn {
            position: fixed; top: 1rem; right: 1rem; z-index: 50;
            width: 55px; height: 55px; border-radius: 50%;
            background: linear-gradient(135deg, #dc2626, #ef4444);
            color: white; border: none; cursor: pointer; font-weight: bold;
            box-shadow: 0 10px 20px rgba(220, 38, 38, 0.4);
            animation: pulse-sos 2s infinite;
            display: flex; align-items: center; justify-content: center;
        }
        @keyframes pulse-sos {
            0% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(220, 38, 38, 0); }
            100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0); }
        }

        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.7); z-index: 1000; align-items: center; justify-content: center;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: white; border-radius: 20px; padding: 1.5rem; width: 90%; max-width: 500px;
            max-height: 90vh; overflow-y: auto;
        }
        
        #chat-area::-webkit-scrollbar { width: 4px; }
        #chat-area::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body>

    <button onclick="openSOSModal()" class="sos-btn">SOS</button>
    <button onclick="openSettingsModal()" style="position: fixed; top: 1rem; left: 1rem; z-index: 50; width: 45px; height: 45px; border-radius: 50%; background: #0d9488; color: white; border: none; cursor: pointer; box-shadow: 0 4px 12px rgba(13, 148, 136, 0.3);">‚öôÔ∏è</button>

    <div style="width: 100%; height: 100%; max-width: 500px; display: flex; flex-direction: column; background: white; border-radius: 0; box-shadow: 0 10px 40px rgba(0,0,0,0.1); overflow: hidden;">
        <header style="background: #0d9488; color: white; padding: 1rem; display: flex; align-items: center; gap: 1rem;">
            <div style="width: 40px; height: 40px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center;">üè•</div>
            <div>
                <h1 style="font-size: 1.1rem; font-weight: bold;">Health Buddy</h1>
                <p id="header-subtitle" style="font-size: 0.75rem; opacity: 0.9;">Symptom Checker & Health Guide</p>
            </div>
        </header>

        <main id="chat-area" style="flex: 1; padding: 1rem; overflow-y: auto; display: flex; flex-direction: column; gap: 0.75rem; background: #f9fafb;"></main>

        <footer style="padding: 1rem; background: white; border-top: 1px solid #e5e7eb; display: flex; align-items: center; gap: 0.5rem;">
            <button onclick="startVoice()" style="color: #64748b;" title="Voice Input">üé§</button>
            <input type="text" id="user-input" style="flex: 1; background: #f3f4f6; border-radius: 9999px; padding: 0.6rem 1.2rem; border: none; outline: none;" placeholder="Type here...">
            <button onclick="sendMessage()" style="background: #0d9488; color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">‚ûî</button>
        </footer>
    </div>

    <div id="sos-modal" class="modal">
        <div class="modal-content text-center">
            <h2 id="sos-title" class="text-2xl font-bold text-red-600 mb-4">üö® EMERGENCY SOS üö®</h2>
            <div id="sos-timer" class="text-4xl font-mono font-bold mb-4">00:00</div>
            <p id="sos-status" class="mb-4 text-gray-600">Detecting location...</p>
            <button id="btn-sos-call" onclick="quickCall('108')" class="w-full bg-green-600 text-white p-3 rounded-lg mb-2 font-bold">üìû Call Ambulance (108)</button>
            <button id="btn-sos-sms" onclick="sendEmergencySMS()" class="w-full bg-blue-600 text-white p-3 rounded-lg mb-2 font-bold">üí¨ SMS My Location</button>
            <button id="btn-sos-cancel" onclick="closeSOSModal()" class="w-full bg-gray-400 text-white p-3 rounded-lg font-bold">Cancel</button>
        </div>
    </div>

    <div id="settings-modal" class="modal">
        <div class="modal-content">
            <h2 id="settings-title" class="text-xl font-bold text-teal-700 mb-4">‚öôÔ∏è Health Profile</h2>
            <label class="block text-sm font-medium text-gray-700 mb-1">Language / ‡§≠‡§æ‡§∑‡§æ</label>
            <select id="lang-switch" class="w-full border p-2 mb-4 rounded bg-white" onchange="changeLanguage(this.value)">
                <option value="en">English</option>
                <option value="hi">‡§π‡§ø‡§Ç‡§¶‡•Ä (Hindi)</option>
            </select>
            <input type="number" id="p-age" placeholder="Age" class="w-full border p-2 mb-2 rounded">
            <input type="text" id="p-blood" placeholder="Blood Group" class="w-full border p-2 mb-2 rounded">
            <textarea id="p-allergies" placeholder="Allergies" class="w-full border p-2 mb-4 rounded"></textarea>
            <button id="btn-save-settings" onclick="saveProfile()" class="w-full bg-teal-600 text-white p-3 rounded-lg font-bold">Save Changes</button>
            <button id="btn-close-settings" onclick="closeSettingsModal()" class="w-full mt-2 text-gray-500">Close</button>
        </div>
    </div>

    <script>
        const GEMINI_API_KEY = ""; 
        let currentLang = 'en';
        let userName = '';
        let flowState = 'lang_selection'; 
        let currentSymptomData = null;
        let followUpIndex = 0;
        let collectedAnswers = {};
        let userWeight = 0;
        let sosStartTime;

        const i18n = {
            en: {
                welcome: "Welcome! I'm your Health Buddy. Please select your language:",
                askName: "Excellent! What is your name?",
                menuGreeting: "Nice to meet you, <b>{name}</b>! How can I help you today?",
                menuOptions: ['Symptom Checker', 'Medicine Info', 'Ask Health Question', 'Find Hospital', 'BMI Calculator'],
                promptSymptom: "What symptoms are you experiencing? (e.g. fever, cough, headache, stomach pain)",
                promptMedicine: "Enter a medicine name to get details (e.g. Paracetamol, Metformin, Aspirin):",
                promptAsk: "Go ahead, ask me anything about health, nutrition, or medicine.",
                promptPincode: "Please enter your 6-digit Pincode:",
                promptWeight: "What is your weight in kg?",
                promptHeight: "What is your height in cm?",
                bmiResult: "Your BMI is <b>{bmi}</b>. ({category})",
                assessmentTitle: "Assessment",
                disclaimer: "<i>Disclaimer: This is not a professional diagnosis. Always consult a doctor for medical advice.</i>",
                sosDetecting: "Detecting location...",
                sosLocationFound: "üìç Location found: ",
                headerSubtitle: "Symptom Checker & Health Guide",
                settingsTitle: "Health Profile",
                btnSave: "Save Changes",
                btnClose: "Close",
                btnYes: "Yes",
                btnNo: "No",
                aiChecking: "Checking database and AI...",
                aiResponse: "ü§ñ Result: ",
                medNotFound: "Not in local list. Asking AI..."
            },
            hi: {
                welcome: "‡§®‡§Æ‡§∏‡•ç‡§§‡•á! ‡§Æ‡•à‡§Ç ‡§Ü‡§™‡§ï‡§æ ‡§π‡•á‡§≤‡•ç‡§• ‡§¨‡§°‡•Ä ‡§π‡•Ç‡§Å‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§Ö‡§™‡§®‡•Ä ‡§≠‡§æ‡§∑‡§æ ‡§ö‡•Å‡§®‡•á‡§Ç:",
                askName: "‡§¨‡§π‡•Å‡§§ ‡§Ö‡§ö‡•ç‡§õ‡•á! ‡§Ü‡§™‡§ï‡§æ ‡§®‡§æ‡§Æ ‡§ï‡•ç‡§Ø‡§æ ‡§π‡•à?",
                menuGreeting: "‡§Ü‡§™‡§∏‡•á ‡§Æ‡§ø‡§≤‡§ï‡§∞ ‡§ñ‡•Å‡§∂‡•Ä ‡§π‡•Å‡§à, <b>{name}</b>! ‡§Æ‡•à‡§Ç ‡§Ü‡§ú ‡§Ü‡§™‡§ï‡•Ä ‡§ï‡•à‡§∏‡•á ‡§Æ‡§¶‡§¶ ‡§ï‡§∞ ‡§∏‡§ï‡§§‡§æ ‡§π‡•Ç‡§Å?",
                menuOptions: ['‡§≤‡§ï‡•ç‡§∑‡§£ ‡§ú‡§æ‡§Ç‡§ö', '‡§¶‡§µ‡§æ ‡§ï‡•Ä ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä', '‡§∏‡•ç‡§µ‡§æ‡§∏‡•ç‡§•‡•ç‡§Ø ‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§™‡•Ç‡§õ‡•á‡§Ç', '‡§Ö‡§∏‡•ç‡§™‡§§‡§æ‡§≤ ‡§ñ‡•ã‡§ú‡•á‡§Ç', 'BMI ‡§ï‡•à‡§≤‡§ï‡•Å‡§≤‡•á‡§ü‡§∞'],
                promptSymptom: "‡§Ü‡§™‡§ï‡•ã ‡§ï‡•ç‡§Ø‡§æ ‡§≤‡§ï‡•ç‡§∑‡§£ ‡§Æ‡§π‡§∏‡•Ç‡§∏ ‡§π‡•ã ‡§∞‡§π‡•á ‡§π‡•à‡§Ç? (‡§ú‡•à‡§∏‡•á: ‡§¨‡•Å‡§ñ‡§æ‡§∞, ‡§ñ‡§æ‡§Ç‡§∏‡•Ä, ‡§∏‡§ø‡§∞‡§¶‡§∞‡•ç‡§¶, ‡§™‡•á‡§ü ‡§¶‡§∞‡•ç‡§¶)",
                promptMedicine: "‡§¶‡§µ‡§æ ‡§ï‡§æ ‡§®‡§æ‡§Æ ‡§≤‡§ø‡§ñ‡•á‡§Ç (‡§ú‡•à‡§∏‡•á: Paracetamol, Metformin, Aspirin):",
                promptAsk: "‡§Æ‡•Å‡§ù‡§∏‡•á ‡§∏‡•ç‡§µ‡§æ‡§∏‡•ç‡§•‡•ç‡§Ø, ‡§™‡•ã‡§∑‡§£ ‡§Ø‡§æ ‡§¶‡§µ‡§æ ‡§ï‡•á ‡§¨‡§æ‡§∞‡•á ‡§Æ‡•á‡§Ç ‡§ï‡•Å‡§õ ‡§≠‡•Ä ‡§™‡•Ç‡§õ‡•á‡§Ç‡•§",
                promptPincode: "‡§ï‡•É‡§™‡§Ø‡§æ ‡§Ö‡§™‡§®‡§æ 6 ‡§Ö‡§Ç‡§ï‡•ã‡§Ç ‡§ï‡§æ ‡§™‡§ø‡§®‡§ï‡•ã‡§° ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç:",
                promptWeight: "‡§Ü‡§™‡§ï‡§æ ‡§µ‡§ú‡§® ‡§ï‡§ø‡§≤‡•ã‡§ó‡•ç‡§∞‡§æ‡§Æ (kg) ‡§Æ‡•á‡§Ç ‡§ï‡•ç‡§Ø‡§æ ‡§π‡•à?",
                promptHeight: "‡§Ü‡§™‡§ï‡•Ä ‡§ä‡§Ç‡§ö‡§æ‡§à ‡§∏‡•á‡§Ç‡§ü‡•Ä‡§Æ‡•Ä‡§ü‡§∞ (cm) ‡§Æ‡•á‡§Ç ‡§ï‡•ç‡§Ø‡§æ ‡§π‡•à?",
                bmiResult: "‡§Ü‡§™‡§ï‡§æ BMI <b>{bmi}</b> ‡§π‡•à‡•§ ({category})",
                assessmentTitle: "‡§Ü‡§ï‡§≤‡§®",
                disclaimer: "<i>‡§Ö‡§∏‡•ç‡§µ‡•Ä‡§ï‡§∞‡§£: ‡§Ø‡§π ‡§™‡•á‡§∂‡•á‡§µ‡§∞ ‡§®‡§ø‡§¶‡§æ‡§® ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§ö‡§ø‡§ï‡§ø‡§§‡•ç‡§∏‡§æ ‡§∏‡§≤‡§æ‡§π ‡§ï‡•á ‡§≤‡§ø‡§è ‡§°‡•â‡§ï‡•ç‡§ü‡§∞ ‡§∏‡•á ‡§Æ‡§ø‡§≤‡•á‡§Ç‡•§</i>",
                sosDetecting: "‡§≤‡•ã‡§ï‡•á‡§∂‡§® ‡§ñ‡•ã‡§ú‡•Ä ‡§ú‡§æ ‡§∞‡§π‡•Ä ‡§π‡•à...",
                sosLocationFound: "üìç ‡§≤‡•ã‡§ï‡•á‡§∂‡§® ‡§Æ‡§ø‡§≤ ‡§ó‡§à: ",
                headerSubtitle: "‡§≤‡§ï‡•ç‡§∑‡§£ ‡§ú‡§æ‡§Ç‡§ö ‡§î‡§∞ ‡§∏‡•ç‡§µ‡§æ‡§∏‡•ç‡§•‡•ç‡§Ø ‡§ó‡§æ‡§á‡§°",
                settingsTitle: "‡§∏‡•ç‡§µ‡§æ‡§∏‡•ç‡§•‡•ç‡§Ø ‡§™‡•ç‡§∞‡•ã‡§´‡§º‡§æ‡§á‡§≤",
                btnSave: "‡§™‡§∞‡§ø‡§µ‡§∞‡•ç‡§§‡§® ‡§∏‡§π‡•á‡§ú‡•á‡§Ç",
                btnClose: "‡§¨‡§Ç‡§¶ ‡§ï‡§∞‡•á‡§Ç",
                btnYes: "‡§π‡§æ‡§Å",
                btnNo: "‡§®‡§π‡•Ä‡§Ç",
                aiChecking: "‡§°‡•á‡§ü‡§æ‡§¨‡•á‡§∏ ‡§î‡§∞ AI ‡§ï‡•Ä ‡§ú‡§æ‡§Ç‡§ö ‡§ï‡•Ä ‡§ú‡§æ ‡§∞‡§π‡•Ä ‡§π‡•à...",
                aiResponse: "ü§ñ ‡§™‡§∞‡§ø‡§£‡§æ‡§Æ: ",
                medNotFound: "‡§∏‡•ç‡§•‡§æ‡§®‡•Ä‡§Ø ‡§∏‡•Ç‡§ö‡•Ä ‡§Æ‡•á‡§Ç ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ‡•§ AI ‡§∏‡•á ‡§™‡•Ç‡§õ ‡§∞‡§π‡§æ ‡§π‡•Ç‡§Å..."
            }
        };

        const symptomsEngine = {
            "fever": {
                en: {
                    questions: [{ q: "Is it high (above 102¬∞F) with chills?", key: "chills" }, { q: "Do you have severe joint/bone pain?", key: "joint_pain" }, { q: "Is there a skin rash?", key: "rash" }],
                    diagnose: (ans) => {
                        if (ans.joint_pain && ans.rash) return "Likely **Dengue**. Drink plenty of fluids, rest, and monitor platelet count.";
                        if (ans.chills) return "Possible **Malaria**. Consult a doctor for a blood test.";
                        return "Likely **Viral Fever**. Rest and stay hydrated. If it persists > 3 days, see a doctor.";
                    }
                },
                hi: {
                    questions: [{ q: "‡§ï‡•ç‡§Ø‡§æ ‡§Ø‡§π ‡§†‡§Ç‡§° ‡§ï‡•á ‡§∏‡§æ‡§• ‡§§‡•á‡§ú (102¬∞F ‡§∏‡•á ‡§ä‡§™‡§∞) ‡§π‡•à?", key: "chills" }, { q: "‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™‡§ï‡•ã ‡§ú‡•ã‡§°‡§º‡•ã‡§Ç ‡§Ø‡§æ ‡§π‡§°‡•ç‡§°‡§ø‡§Ø‡•ã‡§Ç ‡§Æ‡•á‡§Ç ‡§§‡•á‡§ú ‡§¶‡§∞‡•ç‡§¶ ‡§π‡•à?", key: "joint_pain" }, { q: "‡§ï‡•ç‡§Ø‡§æ ‡§§‡•ç‡§µ‡§ö‡§æ ‡§™‡§∞ ‡§ö‡§ï‡§§‡•ç‡§§‡•á (rash) ‡§π‡•à‡§Ç?", key: "rash" }],
                    diagnose: (ans) => {
                        if (ans.joint_pain && ans.rash) return "‡§∏‡§Ç‡§≠‡§æ‡§µ‡§ø‡§§ **‡§°‡•á‡§Ç‡§ó‡•Ç**‡•§ ‡§ñ‡•Ç‡§¨ ‡§§‡§∞‡§≤ ‡§™‡§¶‡§æ‡§∞‡•ç‡§• ‡§™‡§ø‡§è‡§Ç, ‡§Ü‡§∞‡§æ‡§Æ ‡§ï‡§∞‡•á‡§Ç ‡§î‡§∞ ‡§™‡•ç‡§≤‡•á‡§ü‡§≤‡•á‡§ü ‡§ï‡§æ‡§â‡§Ç‡§ü ‡§ï‡•Ä ‡§®‡§ø‡§ó‡§∞‡§æ‡§®‡•Ä ‡§ï‡§∞‡•á‡§Ç‡•§";
                        if (ans.chills) return "‡§∏‡§Ç‡§≠‡§æ‡§µ‡§ø‡§§ **‡§Æ‡§≤‡•á‡§∞‡§ø‡§Ø‡§æ**‡•§ ‡§∞‡§ï‡•ç‡§§ ‡§™‡§∞‡•Ä‡§ï‡•ç‡§∑‡§£ ‡§ï‡•á ‡§≤‡§ø‡§è ‡§°‡•â‡§ï‡•ç‡§ü‡§∞ ‡§∏‡•á ‡§Æ‡§ø‡§≤‡•á‡§Ç‡•§";
                        return "‡§∏‡§Ç‡§≠‡§æ‡§µ‡§ø‡§§ **‡§µ‡§æ‡§Ø‡§∞‡§≤ ‡§¨‡•Å‡§ñ‡§æ‡§∞**‡•§ ‡§Ü‡§∞‡§æ‡§Æ ‡§ï‡§∞‡•á‡§Ç ‡§î‡§∞ ‡§π‡§æ‡§á‡§°‡•ç‡§∞‡•á‡§ü‡•á‡§° ‡§∞‡§π‡•á‡§Ç‡•§";
                    }
                }
            },
            "cough": {
                en: {
                    questions: [{ q: "Is the cough dry or with phlegm?", key: "phlegm" }, { q: "Do you have difficulty breathing or wheezing?", key: "breath" }, { q: "Has it lasted more than 2 weeks?", key: "duration" }],
                    diagnose: (ans) => {
                        if (ans.breath) return "Possible **Asthma** or **Bronchitis**. Seek medical help if breathing is difficult.";
                        if (ans.duration) return "Requires testing for **Tuberculosis**. Please visit a clinic.";
                        if (ans.phlegm) return "Likely **Chest Infection**. Steam inhalation may help.";
                        return "Likely **Common Cold** or allergies.";
                    }
                },
                hi: {
                    questions: [{ q: "‡§ï‡•ç‡§Ø‡§æ ‡§ñ‡§æ‡§Ç‡§∏‡•Ä ‡§∏‡•Ç‡§ñ‡•Ä ‡§π‡•à ‡§Ø‡§æ ‡§¨‡§≤‡§ó‡§Æ ‡§µ‡§æ‡§≤‡•Ä?", key: "phlegm" }, { q: "‡§ï‡•ç‡§Ø‡§æ ‡§∏‡§æ‡§Ç‡§∏ ‡§≤‡•á‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡§ï‡§≤‡•Ä‡§´ ‡§π‡•ã ‡§∞‡§π‡•Ä ‡§π‡•à?", key: "breath" }, { q: "‡§ï‡•ç‡§Ø‡§æ ‡§Ø‡§π 2 ‡§∏‡§™‡•ç‡§§‡§æ‡§π ‡§∏‡•á ‡§Ö‡§ß‡§ø‡§ï ‡§∏‡§Æ‡§Ø ‡§∏‡•á ‡§π‡•à?", key: "duration" }],
                    diagnose: (ans) => {
                        if (ans.breath) return "‡§∏‡§Ç‡§≠‡§æ‡§µ‡§ø‡§§ **‡§¶‡§Æ‡§æ** ‡§Ø‡§æ **‡§¨‡•ç‡§∞‡•ã‡§Ç‡§ï‡§æ‡§á‡§ü‡§ø‡§∏**‡•§ ‡§∏‡§æ‡§Ç‡§∏ ‡§≤‡•á‡§®‡•á ‡§Æ‡•á‡§Ç ‡§¶‡§ø‡§ï‡•ç‡§ï‡§§ ‡§π‡•ã‡§®‡•á ‡§™‡§∞ ‡§°‡•â‡§ï‡•ç‡§ü‡§∞ ‡§∏‡•á ‡§Æ‡§ø‡§≤‡•á‡§Ç‡•§";
                        if (ans.duration) return "‡§§‡§™‡•á‡§¶‡§ø‡§ï (TB) ‡§ï‡•á ‡§™‡§∞‡•Ä‡§ï‡•ç‡§∑‡§£ ‡§ï‡•Ä ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï‡§§‡§æ ‡§π‡•à‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§ï‡•ç‡§≤‡•Ä‡§®‡§ø‡§ï ‡§ú‡§æ‡§è‡§Ç‡•§";
                        return "‡§∏‡§Ç‡§≠‡§æ‡§µ‡§ø‡§§ **‡§∏‡§æ‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§∏‡§∞‡•ç‡§¶‡•Ä** ‡§Ø‡§æ ‡§è‡§≤‡§∞‡•ç‡§ú‡•Ä‡•§";
                    }
                }
            },
            "headache": {
                en: {
                    questions: [{ q: "Is there neck stiffness or high fever?", key: "stiffness" }, { q: "Is the pain on one side with nausea?", key: "nausea" }],
                    diagnose: (ans) => {
                        if (ans.stiffness) return "üö® **Emergency**: Neck stiffness + Fever could be **Meningitis**. Go to ER immediately.";
                        if (ans.nausea) return "Likely **Migraine**. Rest in a dark, quiet room.";
                        return "Likely **Tension Headache**. Stay hydrated and rest.";
                    }
                },
                hi: {
                    questions: [{ q: "‡§ï‡•ç‡§Ø‡§æ ‡§ó‡§∞‡•ç‡§¶‡§® ‡§Æ‡•á‡§Ç ‡§Ö‡§ï‡§°‡§º‡§® ‡§Ø‡§æ ‡§§‡•á‡§ú ‡§¨‡•Å‡§ñ‡§æ‡§∞ ‡§π‡•à?", key: "stiffness" }, { q: "‡§ï‡•ç‡§Ø‡§æ ‡§¶‡§∞‡•ç‡§¶ ‡§è‡§ï ‡§§‡§∞‡§´ ‡§π‡•à ‡§î‡§∞ ‡§Æ‡§§‡§≤‡•Ä ‡§Æ‡§π‡§∏‡•Ç‡§∏ ‡§π‡•ã ‡§∞‡§π‡•Ä ‡§π‡•à?", key: "nausea" }],
                    diagnose: (ans) => {
                        if (ans.stiffness) return "üö® **‡§á‡§Æ‡§∞‡§ú‡•á‡§Ç‡§∏‡•Ä**: ‡§ó‡§∞‡•ç‡§¶‡§® ‡§Æ‡•á‡§Ç ‡§Ö‡§ï‡§°‡§º‡§® ‡§î‡§∞ ‡§¨‡•Å‡§ñ‡§æ‡§∞ **‡§Æ‡•á‡§®‡§ø‡§®‡•ç‡§ú‡§æ‡§á‡§ü‡§ø‡§∏** ‡§π‡•ã ‡§∏‡§ï‡§§‡§æ ‡§π‡•à‡•§ ‡§§‡•Å‡§∞‡§Ç‡§§ ‡§Ö‡§∏‡•ç‡§™‡§§‡§æ‡§≤ ‡§ú‡§æ‡§è‡§Ç‡•§";
                        if (ans.nausea) return "‡§∏‡§Ç‡§≠‡§æ‡§µ‡§ø‡§§ **‡§Æ‡§æ‡§á‡§ó‡•ç‡§∞‡•á‡§®**‡•§ ‡§Ö‡§Ç‡§ß‡•á‡§∞‡•á ‡§ï‡§Æ‡§∞‡•á ‡§Æ‡•á‡§Ç ‡§Ü‡§∞‡§æ‡§Æ ‡§ï‡§∞‡•á‡§Ç‡•§";
                        return "‡§∏‡§Ç‡§≠‡§æ‡§µ‡§ø‡§§ **‡§§‡§®‡§æ‡§µ ‡§∏‡§ø‡§∞‡§¶‡§∞‡•ç‡§¶**‡•§";
                    }
                }
            },
            "stomach": {
                en: {
                    questions: [{ q: "Burning sensation in chest?", key: "acid" }, { q: "Sharp pain in lower right side?", key: "appendix" }, { q: "Frequent loose motions?", key: "diarrhea" }],
                    diagnose: (ans) => {
                        if (ans.appendix) return "üö® **Warning**: Sharp lower right pain could be **Appendicitis**. See a surgeon immediately.";
                        if (ans.acid) return "Likely **Acid Reflux**. Avoid spicy food.";
                        if (ans.diarrhea) return "Possible **Food Poisoning**. Drink ORS.";
                        return "General **Indigestion**. Rest your stomach.";
                    }
                },
                hi: {
                    questions: [{ q: "‡§∏‡•Ä‡§®‡•á ‡§Æ‡•á‡§Ç ‡§ú‡§≤‡§® ‡§Æ‡§π‡§∏‡•Ç‡§∏ ‡§π‡•ã ‡§∞‡§π‡•Ä ‡§π‡•à?", key: "acid" }, { q: "‡§™‡•á‡§ü ‡§ï‡•á ‡§®‡§ø‡§ö‡§≤‡•á ‡§¶‡§æ‡§π‡§ø‡§®‡•á ‡§π‡§ø‡§∏‡•ç‡§∏‡•á ‡§Æ‡•á‡§Ç ‡§§‡•á‡§ú ‡§¶‡§∞‡•ç‡§¶ ‡§π‡•à?", key: "appendix" }, { q: "‡§¨‡§æ‡§∞-‡§¨‡§æ‡§∞ ‡§¶‡§∏‡•ç‡§§ ‡§π‡•ã ‡§∞‡§π‡•á ‡§π‡•à‡§Ç?", key: "diarrhea" }],
                    diagnose: (ans) => {
                        if (ans.appendix) return "üö® **‡§ö‡•á‡§§‡§æ‡§µ‡§®‡•Ä**: ‡§®‡§ø‡§ö‡§≤‡•á ‡§¶‡§æ‡§π‡§ø‡§®‡•á ‡§π‡§ø‡§∏‡•ç‡§∏‡•á ‡§Æ‡•á‡§Ç ‡§¶‡§∞‡•ç‡§¶ **‡§Ö‡§™‡•á‡§Ç‡§°‡§ø‡§∏‡§æ‡§á‡§ü‡§ø‡§∏** ‡§π‡•ã ‡§∏‡§ï‡§§‡§æ ‡§π‡•à‡•§ ‡§§‡•Å‡§∞‡§Ç‡§§ ‡§°‡•â‡§ï‡•ç‡§ü‡§∞ ‡§∏‡•á ‡§Æ‡§ø‡§≤‡•á‡§Ç‡•§";
                        if (ans.acid) return "‡§∏‡§Ç‡§≠‡§æ‡§µ‡§ø‡§§ **‡§è‡§∏‡§ø‡§°‡§ø‡§ü‡•Ä**‡•§ ‡§Æ‡§∏‡§æ‡§≤‡•á‡§¶‡§æ‡§∞ ‡§≠‡•ã‡§ú‡§® ‡§∏‡•á ‡§¨‡§ö‡•á‡§Ç‡•§";
                        if (ans.diarrhea) return "‡§∏‡§Ç‡§≠‡§æ‡§µ‡§ø‡§§ **‡§´‡•Ç‡§° ‡§™‡•â‡§á‡§ú‡§®‡§ø‡§Ç‡§ó**‡•§ ORS ‡§™‡§ø‡§è‡§Ç‡•§";
                        return "‡§∏‡§æ‡§Æ‡§æ‡§®‡•ç‡§Ø **‡§¨‡§¶‡§π‡§ú‡§Æ‡•Ä**‡•§";
                    }
                }
            },
            "chest pain": {
                en: {
                    questions: [{ q: "Pain radiating to left arm or jaw?", key: "heart" }, { q: "Shortness of breath or sweating?", key: "breath" }],
                    diagnose: (ans) => {
                        return "üö® **CRITICAL**: Chest pain must be evaluated at a hospital (ER) immediately to rule out a **Heart Attack**.";
                    }
                },
                hi: {
                    questions: [{ q: "‡§ï‡•ç‡§Ø‡§æ ‡§¶‡§∞‡•ç‡§¶ ‡§¨‡§æ‡§è‡§Ç ‡§π‡§æ‡§• ‡§Ø‡§æ ‡§ú‡§¨‡§°‡§º‡•á ‡§§‡§ï ‡§ú‡§æ ‡§∞‡§π‡§æ ‡§π‡•à?", key: "heart" }, { q: "‡§∏‡§æ‡§Ç‡§∏ ‡§≤‡•á‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡§ï‡§≤‡•Ä‡§´ ‡§Ø‡§æ ‡§™‡§∏‡•Ä‡§®‡§æ ‡§Ü ‡§∞‡§π‡§æ ‡§π‡•à?", key: "breath" }],
                    diagnose: (ans) => {
                        return "üö® **‡§ó‡§Ç‡§≠‡•Ä‡§∞**: ‡§∏‡•Ä‡§®‡•á ‡§Æ‡•á‡§Ç ‡§¶‡§∞‡•ç‡§¶ ‡§π‡•ã‡§®‡•á ‡§™‡§∞ ‡§§‡•Å‡§∞‡§Ç‡§§ ‡§Ö‡§∏‡•ç‡§™‡§§‡§æ‡§≤ (ER) ‡§ú‡§æ‡§è‡§Ç, ‡§Ø‡§π **‡§¶‡§ø‡§≤ ‡§ï‡§æ ‡§¶‡•å‡§∞‡§æ** ‡§π‡•ã ‡§∏‡§ï‡§§‡§æ ‡§π‡•à‡•§";
                    }
                }
            }
        };

        const medicineDB = {
            "paracetamol": { en: "Pain reliever and fever reducer. Dose: Max 4000mg/day. Side effects: Nausea.", hi: "‡§¶‡§∞‡•ç‡§¶ ‡§®‡§ø‡§µ‡§æ‡§∞‡§ï ‡§î‡§∞ ‡§¨‡•Å‡§ñ‡§æ‡§∞ ‡§ï‡•Ä ‡§¶‡§µ‡§æ‡•§ ‡§°‡•ã‡§ú: ‡§Ö‡§ß‡§ø‡§ï‡§§‡§Æ 4000mg/‡§¶‡§ø‡§®‡•§ ‡§¶‡•Å‡§∑‡•ç‡§™‡•ç‡§∞‡§≠‡§æ‡§µ: ‡§Æ‡§§‡§≤‡•Ä‡•§" },
            "ibuprofen": { en: "NSAID for pain and fever. Take with food. Side effects: Heartburn.", hi: "‡§¶‡§∞‡•ç‡§¶ ‡§î‡§∞ ‡§¨‡•Å‡§ñ‡§æ‡§∞ ‡§ï‡•á ‡§≤‡§ø‡§è‡•§ ‡§≠‡•ã‡§ú‡§® ‡§ï‡•á ‡§∏‡§æ‡§• ‡§≤‡•á‡§Ç‡•§ ‡§¶‡•Å‡§∑‡•ç‡§™‡•ç‡§∞‡§≠‡§æ‡§µ: ‡§∏‡•Ä‡§®‡•á ‡§Æ‡•á‡§Ç ‡§ú‡§≤‡§®‡•§" },
            "metformin": { en: "For Type 2 Diabetes. Take with meals. Side effects: Diarrhea.", hi: "‡§ü‡§æ‡§á‡§™ 2 ‡§Æ‡§ß‡•Å‡§Æ‡•á‡§π ‡§ï‡•á ‡§≤‡§ø‡§è‡•§ ‡§≠‡•ã‡§ú‡§® ‡§ï‡•á ‡§∏‡§æ‡§• ‡§≤‡•á‡§Ç‡•§ ‡§¶‡•Å‡§∑‡•ç‡§™‡•ç‡§∞‡§≠‡§æ‡§µ: ‡§¶‡§∏‡•ç‡§§‡•§" },
            "aspirin": { en: "Pain reliever and blood thinner. Side effects: Stomach irritation.", hi: "‡§¶‡§∞‡•ç‡§¶ ‡§®‡§ø‡§µ‡§æ‡§∞‡§ï ‡§î‡§∞ ‡§ñ‡•Ç‡§® ‡§™‡§§‡§≤‡§æ ‡§ï‡§∞‡§®‡•á ‡§µ‡§æ‡§≤‡•Ä ‡§¶‡§µ‡§æ‡•§ ‡§¶‡•Å‡§∑‡•ç‡§™‡•ç‡§∞‡§≠‡§æ‡§µ: ‡§™‡•á‡§ü ‡§Æ‡•á‡§Ç ‡§ú‡§≤‡§®‡•§" },
            "atorvastatin": { en: "For High Cholesterol. Side effects: Muscle pain.", hi: "‡§ï‡•ã‡§≤‡•á‡§∏‡•ç‡§ü‡•ç‡§∞‡•â‡§≤ ‡§ï‡•á ‡§≤‡§ø‡§è‡•§ ‡§¶‡•Å‡§∑‡•ç‡§™‡•ç‡§∞‡§≠‡§æ‡§µ: ‡§Æ‡§æ‡§Ç‡§∏‡§™‡•á‡§∂‡§ø‡§Ø‡•ã‡§Ç ‡§Æ‡•á‡§Ç ‡§¶‡§∞‡•ç‡§¶‡•§" },
            "amlodipine": { en: "For High Blood Pressure. Side effects: Ankle swelling.", hi: "‡§π‡§æ‡§à ‡§¨‡•Ä‡§™‡•Ä ‡§ï‡•á ‡§≤‡§ø‡§è‡•§ ‡§¶‡•Å‡§∑‡•ç‡§™‡•ç‡§∞‡§≠‡§æ‡§µ: ‡§ü‡§ñ‡§®‡•ã‡§Ç ‡§Æ‡•á‡§Ç ‡§∏‡•Ç‡§ú‡§®‡•§" },
            "amoxicillin": { en: "Antibiotic for bacterial infections. Side effects: Rash, diarrhea.", hi: "‡§¨‡•à‡§ï‡•ç‡§ü‡•Ä‡§∞‡§ø‡§Ø‡§≤ ‡§∏‡§Ç‡§ï‡•ç‡§∞‡§Æ‡§£ ‡§ï‡•á ‡§≤‡§ø‡§è ‡§è‡§Ç‡§ü‡•Ä‡§¨‡§æ‡§Ø‡•ã‡§ü‡§ø‡§ï‡•§ ‡§¶‡•Å‡§∑‡•ç‡§™‡•ç‡§∞‡§≠‡§æ‡§µ: ‡§¶‡§∏‡•ç‡§§‡•§" },
            "omeprazole": { en: "For acidity/GERD. Take before breakfast. Side effects: Gas.", hi: "‡§è‡§∏‡§ø‡§°‡§ø‡§ü‡•Ä ‡§ï‡•á ‡§≤‡§ø‡§è‡•§ ‡§®‡§æ‡§∂‡•ç‡§§‡•á ‡§∏‡•á ‡§™‡§π‡§≤‡•á ‡§≤‡•á‡§Ç‡•§" },
            "azithromycin": { en: "Antibiotic for lung infections. Side effects: Stomach cramps.", hi: "‡§∏‡§Ç‡§ï‡•ç‡§∞‡§Æ‡§£ ‡§ï‡•á ‡§≤‡§ø‡§è ‡§è‡§Ç‡§ü‡•Ä‡§¨‡§æ‡§Ø‡•ã‡§ü‡§ø‡§ï‡•§ ‡§¶‡•Å‡§∑‡•ç‡§™‡•ç‡§∞‡§≠‡§æ‡§µ: ‡§™‡•á‡§ü ‡§Æ‡•á‡§Ç ‡§Æ‡§∞‡•ã‡§°‡§º‡•§" },
            "cetirizine": { en: "For allergies. Side effects: Mild sleepiness.", hi: "‡§è‡§≤‡§∞‡•ç‡§ú‡•Ä ‡§ï‡•á ‡§≤‡§ø‡§è‡•§ ‡§¶‡•Å‡§∑‡•ç‡§™‡•ç‡§∞‡§≠‡§æ‡§µ: ‡§π‡§≤‡•ç‡§ï‡•Ä ‡§®‡•Ä‡§Ç‡§¶‡•§" }
        };

        const chatArea = document.getElementById('chat-area');
        const userInput = document.getElementById('user-input');

        function addMsg(text, type) {
            const div = document.createElement('div');
            div.className = `p-3 rounded-2xl max-w-[85%] shadow-sm text-sm ${type === 'user' ? 'chat-bubble-user ml-auto' : 'chat-bubble-bot mr-auto'}`;
            div.innerHTML = text;
            chatArea.appendChild(div);
            chatArea.scrollTop = chatArea.scrollHeight;
        }

        function showButtons(options, callback) {
            const wrap = document.createElement('div');
            wrap.className = 'flex flex-wrap gap-2 my-2';
            options.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = 'menu-button';
                btn.innerText = opt;
                btn.onclick = () => {
                    addMsg(opt, 'user');
                    wrap.remove();
                    callback(opt);
                };
                wrap.appendChild(btn);
            });
            chatArea.appendChild(wrap);
            chatArea.scrollTop = chatArea.scrollHeight;
        }

        function changeLanguage(lang) {
            currentLang = lang;
            updateUIStrings();
            showMenu();
        }

        function updateUIStrings() {
            const t = i18n[currentLang];
            document.getElementById('header-subtitle').innerText = t.headerSubtitle;
            document.getElementById('settings-title').innerText = t.settingsTitle;
            document.getElementById('btn-save-settings').innerText = t.btnSave;
            document.getElementById('btn-close-settings').innerText = t.btnClose;
            userInput.placeholder = currentLang === 'en' ? "Type here..." : "‡§Ø‡§π‡§æ‡§Å ‡§≤‡§ø‡§ñ‡•á‡§Ç...";
        }

        async function processInput(val) {
            const msg = val.trim();
            const lowerVal = msg.toLowerCase();
            const t = i18n[currentLang];

            if (flowState === 'naming') {
                userName = msg;
                flowState = 'menu';
                addMsg(t.menuGreeting.replace('{name}', userName), 'bot');
                showMenu();
            } 
            else if (flowState === 'symptom_start') {
                let match = null;
                for (let key in symptomsEngine) {
                    if (lowerVal.includes(key)) {
                        match = key;
                        break;
                    }
                }

                if (match) {
                    currentSymptomData = symptomsEngine[match][currentLang];
                    followUpIndex = 0;
                    collectedAnswers = {};
                    askFollowUp();
                } else {
                    addMsg(t.aiChecking, 'bot');
                    const aiRes = await getAIResponse(`As a health assistant, please provide a professional assessment for these symptoms: ${val}`);
                    addMsg(t.aiResponse + aiRes, 'bot');
                    setTimeout(showMenu, 6000);
                }
            }
            else if (flowState === 'medicine_search') {
                let foundKey = null;
                const formattedKey = lowerVal.replace(/\s+/g, '-');
                if (medicineDB[formattedKey]) {
                    foundKey = formattedKey;
                } else {
                    for (let key in medicineDB) {
                        if (key.includes(formattedKey) || formattedKey.includes(key)) {
                            foundKey = key;
                            break;
                        }
                    }
                }

                if (foundKey) {
                    const info = medicineDB[foundKey][currentLang];
                    addMsg(`üíä <b>${foundKey.replace(/-/g, ' ').toUpperCase()}</b><br><br>${info}`, 'bot');
                    addMsg(t.disclaimer, 'bot');
                    setTimeout(showMenu, 5000);
                } else {
                    addMsg(t.medNotFound, 'bot');
                    const aiRes = await getAIResponse(`Provide comprehensive medical details for the medicine '${msg}' in ${currentLang}. Include typical uses, side effects, and important health warnings.`);
                    addMsg(t.aiResponse + aiRes, 'bot');
                    setTimeout(showMenu, 5000);
                }
            }
            else if (flowState === 'bmi_w') {
                userWeight = parseFloat(msg);
                if (isNaN(userWeight)) return addMsg("Enter a valid number.", "bot");
                flowState = 'bmi_h';
                addMsg(t.promptHeight, 'bot');
            }
            else if (flowState === 'bmi_h') {
                let height = parseFloat(msg);
                if (isNaN(height)) return addMsg("Enter a valid number.", "bot");
                let bmi = (userWeight / ((height / 100) ** 2)).toFixed(1);
                addMsg(t.bmiResult.replace('{bmi}', bmi).replace('{category}', bmi < 18.5 ? "Underweight" : bmi < 25 ? "Normal" : "Overweight"), 'bot');
                setTimeout(showMenu, 4000);
            }
            else if (flowState === 'pincode') {
                const mapUrl = `https://www.google.com/maps/search/hospitals+near+${msg}/`;
                addMsg(`<a href="${mapUrl}" target="_blank" class="text-blue-600 underline font-bold">Open Maps for ${msg}</a>`, 'bot');
                setTimeout(showMenu, 4000);
            }
            else if (flowState === 'free_ask') {
                const aiRes = await getAIResponse(`As a medical assistant, please answer this query accurately and clearly: ${val}`);
                addMsg(t.aiResponse + aiRes, 'bot');
                setTimeout(showMenu, 6000);
            }
            else if (flowState === 'menu') {
                handleMenu(val);
            }
        }

        function askFollowUp() {
            flowState = 'symptom_followup';
            const qObj = currentSymptomData.questions[followUpIndex];
            const t = i18n[currentLang];
            addMsg(qObj.q, 'bot');
            showButtons([t.btnYes, t.btnNo], (ans) => {
                collectedAnswers[qObj.key] = (ans === t.btnYes);
                followUpIndex++;
                if (followUpIndex < currentSymptomData.questions.length) {
                    askFollowUp();
                } else {
                    const result = currentSymptomData.diagnose(collectedAnswers);
                    addMsg(`ü©∫ <b>${t.assessmentTitle}:</b><br>${result}`, 'bot');
                    addMsg(t.disclaimer, 'bot');
                    setTimeout(showMenu, 6000);
                }
            });
        }

        function showMenu() {
            flowState = 'menu';
            showButtons(i18n[currentLang].menuOptions, handleMenu);
        }

        function handleMenu(choice) {
            const t = i18n[currentLang];
            const idx = t.menuOptions.indexOf(choice);
            if (idx === 0) { flowState = 'symptom_start'; addMsg(t.promptSymptom, 'bot'); } 
            else if (idx === 1) { flowState = 'medicine_search'; addMsg(t.promptMedicine, 'bot'); }
            else if (idx === 2) { flowState = 'free_ask'; addMsg(t.promptAsk, 'bot'); }
            else if (idx === 3) { flowState = 'pincode'; addMsg(t.promptPincode, 'bot'); }
            else if (idx === 4) { flowState = 'bmi_w'; addMsg(t.promptWeight, 'bot'); }
        }

        async function getAIResponse(prompt) {
            if (!GEMINI_API_KEY) return currentLang === 'en' ? "AI services are currently limited. Please consult a doctor." : "AI ‡§∏‡•á‡§µ‡§æ‡§è‡§Ç ‡§Ö‡§≠‡•Ä ‡§∏‡•Ä‡§Æ‡§ø‡§§ ‡§π‡•à‡§Ç‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§°‡•â‡§ï‡•ç‡§ü‡§∞ ‡§∏‡•á ‡§∏‡§≤‡§æ‡§π ‡§≤‡•á‡§Ç‡•§";
            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const d = await res.json();
                return d.candidates[0].content.parts[0].text;
            } catch (e) { return "..."; }
        }

        function sendMessage() {
            const v = userInput.value.trim();
            if (!v) return;
            addMsg(v, 'user');
            userInput.value = '';
            processInput(v);
        }

        function init() {
            addMsg("Language / ‡§≠‡§æ‡§∑‡§æ ‡§ö‡•Å‡§®‡•á‡§Ç:", 'bot');
            showButtons(['English', '‡§π‡§ø‡§Ç‡§¶‡•Ä'], (choice) => {
                currentLang = choice === 'English' ? 'en' : 'hi';
                updateUIStrings();
                flowState = 'naming';
                addMsg(i18n[currentLang].askName, 'bot');
            });
        }

        function openSOSModal() {
            document.getElementById('sos-modal').classList.add('active');
            sosStartTime = Date.now();
            updateSOSTimer();
            const t = i18n[currentLang];
            navigator.geolocation.getCurrentPosition(p => {
                document.getElementById('sos-status').innerHTML = t.sosLocationFound + `${p.coords.latitude.toFixed(4)}, ${p.coords.longitude.toFixed(4)}`;
            });
        }

        function closeSOSModal() {
            document.getElementById('sos-modal').classList.remove('active');
        }

        function updateSOSTimer() {
            if (!document.getElementById('sos-modal').classList.contains('active')) return;
            const elapsed = Math.floor((Date.now() - sosStartTime) / 1000);
            const m = Math.floor(elapsed / 60).toString().padStart(2, '0');
            const s = (elapsed % 60).toString().padStart(2, '0');
            document.getElementById('sos-timer').innerText = `${m}:${s}`;
            setTimeout(updateSOSTimer, 1000);
        }

        function quickCall(n) {
            window.location.href = `tel:${n}`;
        }

        function sendEmergencySMS() {
            const statusText = document.getElementById('sos-status').innerText;
            const userNameText = userName ? ` (User: ${userName})` : "";
            const msg = `üÜò SOS ALERT! I need immediate medical help! ${statusText}${userNameText}. Please send assistance urgently.`;
            window.location.href = `sms:?body=${encodeURIComponent(msg)}`;
        }

        function openSettingsModal() { document.getElementById('settings-modal').classList.add('active'); }
        function closeSettingsModal() { document.getElementById('settings-modal').classList.remove('active'); }
        function saveProfile() { addMsg("Saved!", "bot"); closeSettingsModal(); }

        function startVoice() {
            const rec = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!rec) return;
            const recognition = new rec();
            recognition.lang = currentLang === 'hi' ? 'hi-IN' : 'en-US';
            recognition.onresult = (e) => {
                userInput.value = e.results[0][0].transcript;
                sendMessage();
            };
            recognition.start();
        }

        window.onload = init;
        userInput.addEventListener("keypress", (e) => { if(e.key === "Enter") sendMessage(); });
    </script>
</body>
</html>